# Incremental Sync Configuration (Upsert Mode)
#
# Upsert mode performs incremental synchronization:
# - INSERT new rows (not in target)
# - UPDATE changed rows (all columns compared)
# - LEAVE rows that exist only in target (no deletes)
#
# IMPORTANT: Upsert mode requires target tables to already exist!
# Recommended workflow:
#   1. Initial load: Run with target_mode: drop_recreate (fast bulk copy)
#   2. Incremental syncs: Run with target_mode: upsert (only changed rows)
#
# Requirements:
# - All tables must have primary keys (source and target)
# - Target tables must already exist with PK constraints
#
# Date-Based Incremental Loading:
# - Configure date_updated_columns to filter rows by last-modified date
# - Highwater marks are stored automatically in the state database
# - Subsequent runs only fetch rows modified since the last sync
# - Dramatically reduces transfer time for large tables with few changes
#
# NEW: drop_recreate can pre-populate timestamps for upsert!
# - Add date_updated_columns to your drop_recreate config
# - drop_recreate records sync timestamps WITHOUT applying date filters (full load)
# - Subsequent upsert runs use those timestamps for incremental sync
# - Eliminates the need for a "first sync" full-table upsert after drop_recreate
#
# Performance Notes:
# - Full upsert is 2-5x slower than drop_recreate (index maintenance overhead)
# - Incremental upsert with date filtering is extremely fast (seconds vs minutes)
# - PostgreSQL uses batched multi-row INSERT...ON CONFLICT
# - SQL Server uses staging table + UPDATE/INSERT
#
# Usage:
#   # Step 1: Initial load with timestamp recording
#   # (Add date_updated_columns to your drop_recreate config)
#   ./mssql-pg-migrate -c config-drop-recreate.yaml run
#
#   # Step 2: Incremental syncs (uses timestamps from step 1)
#   export MSSQL_PASSWORD="your-mssql-password"
#   export PG_PASSWORD="your-postgres-password"
#   ./mssql-pg-migrate -c examples/config-upsert.yaml run

source:
  type: mssql
  host: sqlserver.example.com
  port: 1433
  database: SourceDatabase
  user: sa
  password: ${MSSQL_PASSWORD}
  schema: dbo
  encrypt: "true"
  trust_server_cert: false

target:
  type: postgres
  host: postgres.example.com
  port: 5432
  database: target_db
  user: postgres
  password: ${PG_PASSWORD}
  schema: public
  ssl_mode: require

migration:
  workers: 4
  chunk_size: 10000       # Smaller chunks recommended for upsert
  target_mode: upsert     # Enable incremental sync

  # Date columns for incremental loading (tries each column name in order)
  # Supported types: datetime, datetime2, timestamp, timestamptz, date
  # Highwater marks are stored automatically - subsequent runs only fetch
  # rows where date_column > last_sync_timestamp
  date_updated_columns:
    - UpdatedAt           # Common convention
    - ModifiedDate        # SQL Server convention
    - LastModified
    - CreationDate        # Fallback for append-only tables

  # Optional: Filter tables for incremental sync
  # include_tables:
  #   - orders
  #   - customers
  # exclude_tables:
  #   - audit_*
  #   - temp_*
