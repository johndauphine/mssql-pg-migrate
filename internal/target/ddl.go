package target

import (
	"fmt"
	"strings"

	"github.com/johndauphine/mssql-pg-migrate/internal/source"
	"github.com/johndauphine/mssql-pg-migrate/internal/typemap"
)

// GenerateDDL generates CREATE TABLE statement for PostgreSQL (assumes MSSQL source for backwards compatibility)
func GenerateDDL(t *source.Table, targetSchema string) string {
	return GenerateDDLWithOptions(t, targetSchema, false, "mssql")
}

// GenerateDDLWithOptions generates CREATE TABLE with optional UNLOGGED
// sourceType indicates the source database type ("mssql" or "postgres") for type mapping
func GenerateDDLWithOptions(t *source.Table, targetSchema string, unlogged bool, sourceType string) string {
	var sb strings.Builder

	tableType := "TABLE"
	if unlogged {
		tableType = "UNLOGGED TABLE"
	}

	// Sanitize table name for PostgreSQL
	sanitizedTableName := SanitizePGIdentifier(t.Name)

	sb.WriteString(fmt.Sprintf("CREATE %s IF NOT EXISTS %s (\n",
		tableType, qualifyPGTable(targetSchema, sanitizedTableName)))

	for i, col := range t.Columns {
		if i > 0 {
			sb.WriteString(",\n")
		}

		pgType := typemap.MapType(sourceType, "postgres", col.DataType, col.MaxLength, col.Precision, col.Scale)

		// Sanitize column name
		sanitizedColName := SanitizePGIdentifier(col.Name)

		sb.WriteString(fmt.Sprintf("    %s %s", quotePGIdent(sanitizedColName), pgType))

		if col.IsIdentity {
			sb.WriteString(" GENERATED BY DEFAULT AS IDENTITY")
		}

		if !col.IsNullable {
			sb.WriteString(" NOT NULL")
		}
	}

	sb.WriteString("\n)")

	return sb.String()
}

// GenerateCreatePK generates ALTER TABLE ADD PRIMARY KEY statement
func GenerateCreatePK(t *source.Table, targetSchema string) string {
	if len(t.PrimaryKey) == 0 {
		return ""
	}

	pkCols := make([]string, len(t.PrimaryKey))
	for i, col := range t.PrimaryKey {
		// Sanitize PK column names
		pkCols[i] = quotePGIdent(SanitizePGIdentifier(col))
	}

	// Sanitize table name
	sanitizedTableName := SanitizePGIdentifier(t.Name)

	return fmt.Sprintf("ALTER TABLE %s ADD PRIMARY KEY (%s)",
		qualifyPGTable(targetSchema, sanitizedTableName), strings.Join(pkCols, ", "))
}
